<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>工作小结-钉钉OA审批(2) | Wray Blog</title><meta name="author" content="Wray"><meta name="copyright" content="Wray"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="2023-09-01工作小结，整理下项目搭建钉钉OA审批底层框架的思路。">
<meta property="og:type" content="article">
<meta property="og:title" content="工作小结-钉钉OA审批(2)">
<meta property="og:url" content="https://blog.itwray.com/2023/09/01/work-report-ddoa2/index.html">
<meta property="og:site_name" content="Wray Blog">
<meta property="og:description" content="2023-09-01工作小结，整理下项目搭建钉钉OA审批底层框架的思路。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/drone-8499903_1920.jpg">
<meta property="article:published_time" content="2023-09-01T08:33:36.000Z">
<meta property="article:modified_time" content="2024-04-22T01:52:56.314Z">
<meta property="article:author" content="Wray">
<meta property="article:tag" content="工作小结">
<meta property="article:tag" content="OA审批">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/drone-8499903_1920.jpg"><link rel="shortcut icon" href="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/W.svg"><link rel="canonical" href="https://blog.itwray.com/2023/09/01/work-report-ddoa2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '工作小结-钉钉OA审批(2)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-22 09:52:56'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/touxiang.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Wray Blog"><span class="site-name">Wray Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">工作小结-钉钉OA审批(2)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-01T08:33:36.000Z" title="发表于 2023-09-01 16:33:36">2023-09-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-22T01:52:56.314Z" title="更新于 2024-04-22 09:52:56">2024-04-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B7%A5%E4%BD%9C/">工作</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>22分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="工作小结-钉钉OA审批(2)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="前言"><a class="header-anchor" href="#前言"></a>前言</h2>
<p>在 <a href="https://blog.itwray.com/2023/08/25/work-report-ddoa/">工作小结-钉钉OA审批</a> 中，介绍了钉钉OA审批的基础概念，以及常用的API示例。本章则主要是整理项目搭建钉钉OA审批底层框架的设计思路，并附上源码。</p>
<p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/wangfarui/java-study/tree/main/third-study/dingtalk/dingtalk-oa">https://github.com/wangfarui/java-study/tree/main/third-study/dingtalk/dingtalk-oa</a></p>
<h2 id="框架目录结构"><a class="header-anchor" href="#框架目录结构"></a>框架目录结构</h2>
<p><img src="/2023/09/01/work-report-ddoa2/image-20230901165428927.png" alt="image-20230901165428927"></p>
<p>annotation: 关于钉钉OA审批的自定义注解</p>
<p>client：与钉钉服务端API交互</p>
<p>config：钉钉的属性配置、钉钉相关的Spring Bean配置类</p>
<p>dao：数据持久层</p>
<p>form：钉钉OA审批表单</p>
<p>listener：钉钉回调事件监听器</p>
<p>mapper：数据ORM映射层</p>
<p>model：数据表实体；钉钉OA审批相关对象、枚举</p>
<p>runner：服务启动时，钉钉的启动器</p>
<p>service：钉钉服务层</p>
<p>util：钉钉相关的工具类，例如表单数据格式化工具、Client统一生成工具等</p>
<p>DingTalkAuthManager：钉钉鉴权服务管理器，获取钉钉参数配置的入口</p>
<h2 id="设计思路"><a class="header-anchor" href="#设计思路"></a>设计思路</h2>
<h3 id="数据表设计"><a class="header-anchor" href="#数据表设计"></a>数据表设计</h3>
<ol>
<li>钉钉创建审批表单模板需要 name（模板名称）、formComponents（表单控件）等，因此需要一张审批表单关联表（<em><strong>dd_approval_form_rel</strong></em>）记录业务表单与钉钉表单模板之间的关联信息。</li>
<li>钉钉发起OA审批需要 processCode（模板编号）、originatorUserId（发起人id）、deptId（发起人部门id）等，processCode可以从审批表单关联表获取，但发起人信息得从钉钉获取，获取方式是通过业务系统与钉钉有唯一关联关系的值（例如手机号）进行关联查询，而唯一关联关系的值一般情况下不会变动，所以为了减少不必要的网络请求开销，就需要一张用户关联表（<em><strong>dd_user_rel</strong></em>）记录钉钉用户与业务系统用户之间的关联关系。</li>
<li>在发起OA审批后，钉钉会返回一个 instanceId（审批实例id），通过审批实例id可以随时查看该审批记录的最新操作记录、任务状态、表单控件数据等。为了审批回调时能够快速定位到业务系统的业务单据，所以需要一个审批业务关联表（<em><strong>dd_approval_business_rel</strong></em>）记录钉钉OA审批实例与业务系统的业务单据的关联关系。</li>
<li>因为业务需要，钉钉审批流程的记录希望同步展示到业务系统页面上。通过跑审批示例流程观察，审批流程记录的数据节点与钉钉回调事件中的审批任务事件返回数据节点是一致的，因此审批记录就监听该事件就好。审批记录的内容一般包括审批人、审批流程类型（同意、拒绝、评论、转交、撤销等）、审批评论内容、审批时间，其中审批评论内容支持评论图片以及上传附件，所以需要一个审批流程记录表（<em><strong>dd_approval_process_log</strong></em>）和一个审批流程记录附件表（<em><strong>dd_approval_process_log_attachment</strong></em>）。</li>
</ol>
<h3 id="关键类设计"><a class="header-anchor" href="#关键类设计"></a>关键类设计</h3>
<ol>
<li>
<p>钉钉的服务端API基本上都要token入参，有些接口还需要用户id、应用id、存储空间id等，而这些参数基本上都是“固定的”。因此需要一个统一获取钉钉参数配置类，并且这个类具有缓存效果。（<strong>DingTalkAuthManager</strong>）</p>
</li>
<li>
<p>钉钉服务端API的交互方式是使用SDK，而SDK又分为新版SDK和旧版SDK，为了方便管理，因此使用 <strong>DingTalkApiClientUtil</strong> 创建Client，在 client 包下实现与API的交互，根据Client类型分为多个类进行管理。</p>
<p><img src="/2023/09/01/work-report-ddoa2/image-20230901174559277.png" alt="image-20230901174559277"></p>
</li>
<li>
<p>因为是搭建钉钉OA审批底层框架，要支持业务服务能够快捷、易用、低侵入的接入，同时支持各种场景下的审批控件内容，就需要设计一个表单工具类，可以解析各种表单控件类型并格式化表单数据。</p>
<ol>
<li>钉钉OA审批的表单控件类型都是纯文本描述的，SDK未提供相关的字典类，所以首先需要自己维护一个表单控件类型字典（<strong>ComponentType</strong>），为了尽可能的易用，我创造了一个 <strong>AUTO</strong> 控件类型，让框架通过“约定”的方式自动识别控件类型。相应实现方法在 <em><strong>DingTalkFormUtil#generateFormComponent(Field field)</strong></em> 。</li>
<li>不同的表单控件类型在发起审批实例时，需要的表单数据格式是不一样的（在整体上如钉钉开放平台文档所说确实结构一致），例如表格、附件、关联审批单等，它们的 value 参数值就与平常控件区别很大。相应实现方法在 <em><strong>DingTalkFormUtil#generateFormComponentValues(Field field, ApprovalFormEngine approvalForm)</strong></em> 。</li>
</ol>
</li>
<li>
<p>第3条说的表单工具类是为了解析表单对象，表单对象就是一个Java Class类，通过注解（<em><strong>FormComponent</strong></em>）标记字段以表示表单控件。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.FIELD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FormComponent {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表单控件名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表单控件id</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;表单控件列表中唯一&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">id</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表单控件类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ComponentType <span class="title function_">componentType</span><span class="params">()</span> <span class="keyword">default</span> ComponentType.AUTO;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否非空, 默认不能为空</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">required</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字段为{<span class="doctag">@link</span> java.util.Date}时，日期格式化样式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">pattern</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">"yyyy-MM-dd HH:mm:ss"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<h3 id="发起审批流程"><a class="header-anchor" href="#发起审批流程"></a>发起审批流程</h3>
<p>实现方法在 <em><strong>DingTalkApprovalService#startApprovalFlowInstance(ApprovalFormInstance instance)</strong></em>。</p>
<p>发起审批流程可以细分为四部分：</p>
<ol>
<li>创建并获取审批模板</li>
<li>获取审批发起人对应的钉钉用户信息</li>
<li>发起审批实例，拿取实例id</li>
<li>保存审批实例与业务单据的关联信息</li>
</ol>
<h4 id="入参对象分析"><a class="header-anchor" href="#入参对象分析"></a>入参对象分析</h4>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApprovalFormInstance</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * scm业务id</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;非空&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long businessId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审批流程表单模板对象</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;非空&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ApprovalFormEngine approvalForm;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * scm租户id</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;非空字段，为空时默认从UserUtils获取&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long tenantId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * scm操作人id</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;非空字段，为空时默认从UserUtils获取&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 钉钉部门id</span></span><br><span class="line"><span class="comment">     * &lt;br&gt;</span></span><br><span class="line"><span class="comment">     * TODO 钉钉存在多部门时，需要指定。后期根据产品需求决定是手动指定还是默认指定</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long departmentId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自身关联审批单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">selfRelateField</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在整个对象中，最关键的就是<code>businessId</code>和<code>approvalForm</code>，它们决定了此次发起审批流程的业务关联数据、审批表单数据。</p>
<h4 id="创建并获取审批模板"><a class="header-anchor" href="#创建并获取审批模板"></a>创建并获取审批模板</h4>
<p>实际上，第一步应该叫 <em><strong>获取审批模板编号</strong></em> ，但编号不会凭空产生，所以方法内部的实际操作为：</p>
<ol>
<li>查询审批表单模板关联信息。</li>
<li>查询结果分为两种：
<ol>
<li>关联信息不存在，创建表单模板并返回模板编号。</li>
<li>关联信息存在，判断当前模板版本与关联信息存储的版本是否一致。（版本的存在是为了防止业务端在开发过程中修改已存在的表单模板对象）
<ol>
<li>若一致，直接返回关联信息存储的模板编号。</li>
<li>若不一致，更新表单模板并返回模板编号。</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DdApprovalFormRel <span class="title function_">resolveDdApprovalFormRel</span><span class="params">(ApprovalFormInstance instance)</span> {</span><br><span class="line">    <span class="type">ApprovalFormEngine</span> <span class="variable">approvalForm</span> <span class="operator">=</span> instance.getApprovalForm();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从关联表中查询钉钉表单模板Code</span></span><br><span class="line">    <span class="type">DdApprovalFormRel</span> <span class="variable">ddApprovalFormRel</span> <span class="operator">=</span> ddApprovalFormRelDao.lambdaQuery()</span><br><span class="line">            .eq(DdApprovalFormRel::getTenantId, instance.getTenantId())</span><br><span class="line">            .eq(DdApprovalFormRel::getTypeCode, approvalForm.getBusinessApprovalTypeEnum().getCode())</span><br><span class="line">            .last(<span class="string">"limit 1"</span>)</span><br><span class="line">            .one();</span><br><span class="line">    <span class="keyword">if</span> (ddApprovalFormRel != <span class="literal">null</span>) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> approvalForm.version();</span><br><span class="line">      	<span class="comment">// 版本号是否一致</span></span><br><span class="line">        <span class="keyword">if</span> (version.equals(ddApprovalFormRel.getFormVersion())) {</span><br><span class="line">            <span class="keyword">return</span> ddApprovalFormRel;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> updateDdApprovalFormRel(approvalForm, ddApprovalFormRel);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 关联表无映射时，生成关联数据并返回</span></span><br><span class="line">    <span class="keyword">return</span> createDdApprovalFormRel(instance);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="获取审批发起人对应的钉钉用户信息"><a class="header-anchor" href="#获取审批发起人对应的钉钉用户信息"></a>获取审批发起人对应的钉钉用户信息</h4>
<p>首先，查询用户关联数据；</p>
<p>然后，关联数据为空的话，通过业务用户信息调用钉钉API，查询钉钉用户详情；</p>
<p>最后，建立业务用户与钉钉用户的关联关系数据对象。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DdUserRel <span class="title function_">resolveDdUserRel</span><span class="params">(ApprovalFormInstance instance)</span> {</span><br><span class="line">    <span class="comment">// 查询已关联的用户信息</span></span><br><span class="line">    <span class="type">DdUserRel</span> <span class="variable">ddUserRel</span> <span class="operator">=</span> ddUserRelDao.lambdaQuery()</span><br><span class="line">            .eq(DdUserRel::getTenantId, instance.getTenantId())</span><br><span class="line">            .eq(DdUserRel::getScmUserId, instance.getUserId())</span><br><span class="line">            .last(<span class="string">"limit 1"</span>)</span><br><span class="line">            .one();</span><br><span class="line">    <span class="keyword">if</span> (ddUserRel != <span class="literal">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> ddUserRel;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 通过业务用户信息 创建钉钉用户关联数据</span></span><br><span class="line">    <span class="keyword">return</span> createDdUserRelByScmUser(instance);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> DdUserRel <span class="title function_">createDdUserRelByBusinessUser</span><span class="params">(ApprovalFormInstance dto)</span> {</span><br><span class="line">    <span class="comment">// TODO 根据业务系统用户id查询用户详情</span></span><br><span class="line">    <span class="type">UserResponse</span> <span class="variable">userResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserResponse</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过手机号码查询钉钉用户id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ddUserId</span> <span class="operator">=</span> DingTalkUserInfoClient.getUserIdByMobile(userResponse.getMobile());</span><br><span class="line">    <span class="comment">// 通过钉钉用户id查询钉钉用户详情</span></span><br><span class="line">    OapiV2UserGetResponse.<span class="type">UserGetResponse</span> <span class="variable">ddUserRsp</span> <span class="operator">=</span> DingTalkUserInfoClient.getUserById(ddUserId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新增关联对象</span></span><br><span class="line">    <span class="type">DdUserRel</span> <span class="variable">newEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DdUserRel</span>();</span><br><span class="line">    newEntity.setTenantId(dto.getTenantId());</span><br><span class="line">    newEntity.setScmUserId(dto.getUserId());</span><br><span class="line">    newEntity.setDdUserId(ddUserId);</span><br><span class="line">    newEntity.setDdUserName(userResponse.getUserName());</span><br><span class="line">    newEntity.setUserMobile(userResponse.getMobile());</span><br><span class="line">    newEntity.setDdDeptId(ddUserRsp.getDeptIdList().get(<span class="number">0</span>));</span><br><span class="line">    ddUserRelDao.save(newEntity);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newEntity;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在通过业务用户信息查询钉钉用户详情时，关键参数是“手机号码”。同理，也可以通过钉钉用户的手机号码查询业务用户详情，在“钉钉OA审批回调事件”中就会用到此方法。</p>
<p>还有点需要注意的是，钉钉API目前只支持通过id查详情（不仅限于查询用户详情接口），所以针对查询钉钉id数据的接口，可以统一封装要求返回id不能为空。</p>
<h4 id="发起审批实例"><a class="header-anchor" href="#发起审批实例"></a>发起审批实例</h4>
<p>在第一步和第二步中分别拿到了发起审批实例需要的审批模板编号和审批发起人id，所以现在只需要准备表单数据。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发起审批实例</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> instance          审批表单流程实例对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ddUserRel         钉钉用户关联数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ddApprovalFormRel 钉钉审批表单关联数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> instanceId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SafeVarargs</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">processInstances</span><span class="params">(ApprovalFormInstance instance, DdUserRel ddUserRel, DdApprovalFormRel ddApprovalFormRel,</span></span><br><span class="line"><span class="params">                                      Supplier&lt;StartProcessInstanceRequestFormComponentValues&gt;... expandValues)</span> {</span><br><span class="line">    <span class="type">ApprovalFormEngine</span> <span class="variable">approvalForm</span> <span class="operator">=</span> instance.getApprovalForm();</span><br><span class="line">    <span class="comment">// 请求头</span></span><br><span class="line">    <span class="type">StartProcessInstanceHeaders</span> <span class="variable">startProcessInstanceHeaders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StartProcessInstanceHeaders</span>();</span><br><span class="line">    startProcessInstanceHeaders.setXAcsDingtalkAccessToken(DingTalkAuthManager.getToken());</span><br><span class="line">    <span class="comment">// 构建表单控件元素</span></span><br><span class="line">    List&lt;StartProcessInstanceRequestFormComponentValues&gt; formComponentValues = approvalForm.buildFormComponentValues();</span><br><span class="line">    <span class="comment">// 组装扩展控件值</span></span><br><span class="line">    <span class="keyword">for</span> (Supplier&lt;StartProcessInstanceRequestFormComponentValues&gt; supplier : expandValues) {</span><br><span class="line">        <span class="type">StartProcessInstanceRequestFormComponentValues</span> <span class="variable">value</span> <span class="operator">=</span> supplier.get();</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span>) {</span><br><span class="line">            formComponentValues.add(value);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 表单实例请求对象</span></span><br><span class="line">    <span class="type">StartProcessInstanceRequest</span> <span class="variable">startProcessInstanceRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StartProcessInstanceRequest</span>()</span><br><span class="line">            .setOriginatorUserId(ddUserRel.getDdUserId())</span><br><span class="line">            .setProcessCode(ddApprovalFormRel.getProcessCode())</span><br><span class="line">            .setDeptId(ddUserRel.getDdDeptId())</span><br><span class="line">            .setMicroappAgentId(DingTalkConfig.getTenantPropertiesValue(DingTalkTenantProperties::getAgentId))</span><br><span class="line">            .setFormComponentValues(formComponentValues);</span><br><span class="line">    <span class="comment">// 创建Client并发送请求</span></span><br><span class="line">    <span class="type">Client</span> <span class="variable">workflowClient</span> <span class="operator">=</span> DingTalkApiClientUtil.createWorkflowClient();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="type">StartProcessInstanceResponse</span> <span class="variable">response</span> <span class="operator">=</span> workflowClient.startProcessInstanceWithOptions(</span><br><span class="line">                startProcessInstanceRequest, startProcessInstanceHeaders, <span class="keyword">new</span> <span class="title class_">RuntimeOptions</span>()</span><br><span class="line">        );</span><br><span class="line">        log.info(<span class="string">"[DingTalkWorkflowClient]processInstances: {}"</span>, JSON.toJSONString(response));</span><br><span class="line">        <span class="keyword">return</span> response.getBody().getInstanceId();</span><br><span class="line">    } <span class="keyword">catch</span> (TeaException err) {</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">    } <span class="keyword">catch</span> (Exception _err) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TeaException</span>(_err.getMessage(), _err);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>如你所见，由于当初开发时间节点问题以及业务需求的渗透，该方法没有经过 service 做二次封装，所以在扩展性方面不够友好，为了兼容业务需要的特殊控件，在构建表单控件元素时引入了扩展参数。</p>
<h3 id="审批事件回调"><a class="header-anchor" href="#审批事件回调"></a>审批事件回调</h3>
<p>钉钉回调事件是一个统一入口，OA审批事件是其中的一种。</p>
<p>注册钉钉回调事件分为Http、Stream两种，这里只展示Stream方式接入。</p>
<h4 id="业务回调使用方式"><a class="header-anchor" href="#业务回调使用方式"></a>业务回调使用方式</h4>
<p>业务实现审批回调后置处理的入口就是在Bean对象的方法上加上自定义注解 <code>ApprovalCallback</code> ，并配置相应的业务类型值、审批事件类型即可。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ApprovalCallback {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务审批类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    BusinessApprovalTypeEnum <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审批事件类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;默认所有审批事件都回调&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ApprovalEventType <span class="title function_">eventType</span><span class="params">()</span> <span class="keyword">default</span> ApprovalEventType.ALL;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在业务项目的OA审批中，审批结果大致分为审批同意、审批拒绝、审批中，所以审批事件类型枚举类就设计为：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ApprovalEventType</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有审批事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ALL,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审批 - 同意</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    AGREE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审批 - 拒绝</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    REJECT,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审批 - 进行中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    IN_PROGRESS</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>其中 <code>ALL</code> 表示所有审批结果。</p>
<h4 id="回调方法实现原理"><a class="header-anchor" href="#回调方法实现原理"></a>回调方法实现原理</h4>
<p>在Spring启动应用上下文时，指定扫描自定义的 <code>DingTalkCallbackProcessor</code> 类。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DingTalkCallbackProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(<span class="meta">@NonNull</span> Object bean, <span class="meta">@NonNull</span> String beanName)</span> <span class="keyword">throws</span> BeansException {</span><br><span class="line">        Class&lt;?&gt; clazz = bean.getClass();</span><br><span class="line">        <span class="comment">// Bean初始化前, 扫描Bean的所有方法</span></span><br><span class="line">        <span class="keyword">for</span> (Method method : findAllMethod(clazz)) {</span><br><span class="line">            processMethod(bean, method);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processMethod</span><span class="params">(Object bean, Method method)</span> {</span><br><span class="line">        <span class="type">ApprovalCallback</span> <span class="variable">annotation</span> <span class="operator">=</span> AnnotationUtils.findAnnotation(method, ApprovalCallback.class);</span><br><span class="line">        <span class="keyword">if</span> (annotation == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取方法的入参，要求回调方法的入参个数有切仅有一个，并且入参对象继承自DingTalkCallbackEvent</span></span><br><span class="line">        Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">        Preconditions.checkArgument(parameterTypes.length == <span class="number">1</span>,</span><br><span class="line">                <span class="string">"Invalid number of parameters: %s for method: %s, should be 1"</span>, parameterTypes.length,</span><br><span class="line">                method);</span><br><span class="line">        Preconditions.checkArgument(DingTalkCallbackEvent.class.isAssignableFrom(parameterTypes[<span class="number">0</span>]),</span><br><span class="line">                <span class="string">"Invalid parameter type: %s for method: %s, should be DingTalkCallbackEvent"</span>, parameterTypes[<span class="number">0</span>],</span><br><span class="line">                method);</span><br><span class="line"></span><br><span class="line">        ReflectionUtils.makeAccessible(method);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个钉钉回调监听器，回调实现方法默认调用当前bean对象的方法</span></span><br><span class="line">        <span class="type">DingTalkCallbackListener</span> <span class="variable">dingTalkCallbackListener</span> <span class="operator">=</span> (callbackEvent) -&gt;</span><br><span class="line">                ReflectionUtils.invokeMethod(method, bean, callbackEvent);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将监听器添加到缓存</span></span><br><span class="line">        DingTalkConfig.addCallbackListener(annotation, dingTalkCallbackListener);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Method&gt; <span class="title function_">findAllMethod</span><span class="params">(Class&lt;?&gt; clazz)</span> {</span><br><span class="line">        <span class="keyword">final</span> List&lt;Method&gt; res = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        ReflectionUtils.doWithMethods(clazz, res::add);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>DingTalkCallbackProcessor</code> 类会在启动时，扫描所有Bean对象，并将带有 <code>ApprovalCallback</code> 注解的方法添加到容器中。</p>
<p>容器的实现代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">DingTalkConfig</span> {</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 回调监听器的k-v为：业务审批类型 -&gt; 审批事件类型 -&gt; 监听器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;BusinessApprovalTypeEnum, Map&lt;ApprovalEventType, List&lt;DingTalkCallbackListener&gt;&gt;&gt; CALLBACK_LISTENER_MAP;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> {</span><br><span class="line">      CALLBACK_LISTENER_MAP = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addCallbackListener</span><span class="params">(ApprovalCallback annotation, DingTalkCallbackListener listener)</span> {</span><br><span class="line">        Map&lt;ApprovalEventType, List&lt;DingTalkCallbackListener&gt;&gt; eventTypeMap = CALLBACK_LISTENER_MAP.computeIfAbsent(</span><br><span class="line">                annotation.value(), t -&gt; <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span> &lt;&lt; <span class="number">2</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="type">ApprovalEventType</span> <span class="variable">approvalEventType</span> <span class="operator">=</span> annotation.eventType();</span><br><span class="line">        <span class="keyword">if</span> (ApprovalEventType.ALL.equals(approvalEventType)) {</span><br><span class="line">            addCallbackListener(eventTypeMap, ApprovalEventType.AGREE, listener);</span><br><span class="line">            addCallbackListener(eventTypeMap, ApprovalEventType.REJECT, listener);</span><br><span class="line">            addCallbackListener(eventTypeMap, ApprovalEventType.IN_PROGRESS, listener);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            addCallbackListener(eventTypeMap, approvalEventType, listener);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addCallbackListener</span><span class="params">(Map&lt;ApprovalEventType, List&lt;DingTalkCallbackListener&gt;&gt; eventTypeMap,</span></span><br><span class="line"><span class="params">                                            ApprovalEventType approvalEventType,</span></span><br><span class="line"><span class="params">                                            DingTalkCallbackListener listener)</span> {</span><br><span class="line">        List&lt;DingTalkCallbackListener&gt; listeners = eventTypeMap.get(approvalEventType);</span><br><span class="line">        <span class="keyword">if</span> (listeners == <span class="literal">null</span>) {</span><br><span class="line">            listeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">        }</span><br><span class="line">        listeners.add(listener);</span><br><span class="line">        eventTypeMap.put(approvalEventType, listeners);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;DingTalkCallbackListener&gt; <span class="title function_">getCallbackListener</span><span class="params">(BusinessApprovalTypeEnum approvalTypeEnum,</span></span><br><span class="line"><span class="params">                                                                     ApprovalEventType approvalEventType)</span> {</span><br><span class="line">        Map&lt;ApprovalEventType, List&lt;DingTalkCallbackListener&gt;&gt; eventTypeMap = CALLBACK_LISTENER_MAP.get(approvalTypeEnum);</span><br><span class="line">        <span class="keyword">if</span> (eventTypeMap == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> eventTypeMap.get(approvalEventType);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>通过注解将对应的监听器存放到指定key下，等钉钉回调时，根据钉钉审批回调数据判断审批事件类型，再通过业务审批关联表获取对应的业务审批类型，就可以拿到指定的监听器，发起回调。</p>
<h4 id="回调统一处理方法"><a class="header-anchor" href="#回调统一处理方法"></a>回调统一处理方法</h4>
<p>上文已经说过，钉钉事件回调可以通过Stream方法接入，钉钉用 <code>OpenDingTalkClient</code> 表示钉钉客户端接口，接口就两个方法：启动、停止。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OpenDingTalkClient</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动客户端</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭客户端</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在实例化客户端时，往里面插入事件监听器，再启动，就可以实现钉钉事件回调。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 钉钉客户端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;OpenDingTalkClient&gt; CLIENTS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册钉钉事件Stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerEventStream</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">status</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    Collection&lt;DingTalkTenantProperties&gt; allUniqueAppKeyTenantProperties = DingTalkConfig.getUniqueAppKeyTenantProperties();</span><br><span class="line">    List&lt;OpenDingTalkClient&gt; clientList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(allUniqueAppKeyTenantProperties.size());</span><br><span class="line">    <span class="keyword">for</span> (DingTalkTenantProperties properties : allUniqueAppKeyTenantProperties) {</span><br><span class="line">        <span class="type">OpenDingTalkClient</span> <span class="variable">dingTalkClient</span> <span class="operator">=</span> OpenDingTalkStreamClientBuilder</span><br><span class="line">                .custom()</span><br><span class="line">                .credential(<span class="keyword">new</span> <span class="title class_">AuthClientCredential</span>(properties.getAppKey(), properties.getAppSecret()))</span><br><span class="line">                <span class="comment">// 注册事件监听</span></span><br><span class="line">                .registerAllEventListener(<span class="keyword">new</span> <span class="title class_">ApprovalCallbackEventListener</span>())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            dingTalkClient.start();</span><br><span class="line">            clientList.add(dingTalkClient);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            log.error(<span class="string">"钉钉AppKey为["</span> + properties.getAppKey() + <span class="string">"]的Stream Client启用失败"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 关闭已启动的client</span></span><br><span class="line">    <span class="keyword">for</span> (OpenDingTalkClient client : CLIENTS) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            client.stop();</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            status = <span class="literal">false</span>;</span><br><span class="line">            log.error(<span class="string">"钉钉Client关闭失败"</span>, e);</span><br><span class="line">            <span class="comment">// ignore</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    CLIENTS.clear();</span><br><span class="line">    CLIENTS.addAll(clientList);</span><br><span class="line">    log.info(<span class="string">"钉钉Client注册列表: "</span> + allUniqueAppKeyTenantProperties);</span><br><span class="line">    log.info(<span class="string">"钉钉Client注册"</span> + (status ? <span class="string">"成功"</span> : <span class="string">"异常"</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>其中的 <code>ApprovalCallbackEventListener</code> 就是我们自定义实现的回调OA审批事件监听器，它需要实现钉钉的 <code>GenericEventListener</code> 接口。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GenericEventListener</span> {</span><br><span class="line">  </span><br><span class="line">    <span class="type">GenericEventListener</span> <span class="variable">DEFAULT</span> <span class="operator">=</span> event -&gt; EventAckStatus.SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收到事件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EventAckStatus <span class="title function_">onEvent</span><span class="params">(<span class="keyword">final</span> GenericOpenDingTalkEvent event)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>ApprovalCallbackEventListener</code> 类继承 <code>AbstractDingTalkStreamEventListener</code> 类，表示OA审批回调监听器继承了钉钉回调事件监听器的功能。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractDingTalkStreamEventListener</span> <span class="keyword">implements</span> <span class="title class_">GenericEventListener</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审批任务回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BPMS_TASK_CHANGE</span> <span class="operator">=</span> <span class="string">"bpms_task_change"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审批实例回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BPMS_INSTANCE_CHANGE</span> <span class="operator">=</span> <span class="string">"bpms_instance_change"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> EventAckStatus <span class="title function_">onEvent</span><span class="params">(GenericOpenDingTalkEvent event)</span> {</span><br><span class="line">        MDC.put(<span class="string">"traceId"</span>, UUID.randomUUID().toString().replace(<span class="string">"-"</span>, <span class="string">""</span>));</span><br><span class="line">        log.info(<span class="string">"钉钉回调事件对象: "</span> + JSON.toJSONString(event));</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//事件类型</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">eventType</span> <span class="operator">=</span> event.getEventType();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 确定事件类型，决定data</span></span><br><span class="line">            <span class="keyword">switch</span> (eventType) {</span><br><span class="line">                <span class="keyword">case</span> BPMS_TASK_CHANGE:</span><br><span class="line">                <span class="keyword">case</span> BPMS_INSTANCE_CHANGE:</span><br><span class="line">                    <span class="type">DingTalkCallbackChange</span> <span class="variable">change</span> <span class="operator">=</span> BeanUtil.copyProperties(event, DingTalkCallbackChange.class);</span><br><span class="line">                    handleApprovalEvent(change);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>: {</span><br><span class="line">                    <span class="comment">// 未知的事件类型，忽略</span></span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">//消费成功</span></span><br><span class="line">            <span class="keyword">return</span> EventAckStatus.SUCCESS;</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            log.error(<span class="string">"钉钉回调事件消费失败"</span>, e);</span><br><span class="line">            <span class="comment">//消费失败</span></span><br><span class="line">            <span class="keyword">return</span> EventAckStatus.LATER;</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            MDC.remove(<span class="string">"traceId"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleApprovalEvent</span><span class="params">(DingTalkCallbackChange eventChange)</span> {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApprovalCallbackEventListener</span> <span class="keyword">extends</span> <span class="title class_">AbstractDingTalkStreamEventListener</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DdApprovalBusinessRelService ddApprovalBusinessRelService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DdUserRelService ddUserRelService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DdApprovalProcessLogService ddApprovalProcessLogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleApprovalEvent</span><span class="params">(DingTalkCallbackChange eventChange)</span> {</span><br><span class="line">        <span class="type">ApprovalCallbackEvent</span> <span class="variable">approvalCallbackEvent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApprovalCallbackEvent</span>();</span><br><span class="line"></span><br><span class="line">        ApprovalBaseChange approvalBaseChange;</span><br><span class="line">        <span class="keyword">if</span> (BPMS_TASK_CHANGE.equals(eventChange.getEventType())) {</span><br><span class="line">            approvalCallbackEvent.setApprovalEventType(ApprovalEventType.IN_PROGRESS);</span><br><span class="line">            approvalBaseChange = BeanUtil.copyProperties(eventChange.getData(), ApprovalTaskChange.class);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="type">ApprovalInstanceChange</span> <span class="variable">instanceChange</span> <span class="operator">=</span> BeanUtil.copyProperties(eventChange.getData(), ApprovalInstanceChange.class);</span><br><span class="line">            approvalBaseChange = instanceChange;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ApprovalProcessType.TYPE_FINISH.equals(instanceChange.getType())) {</span><br><span class="line">                <span class="keyword">if</span> (ApprovalProcessType.RESULT_AGREE.equals(instanceChange.getResult())) {</span><br><span class="line">                    approvalCallbackEvent.setApprovalEventType(ApprovalEventType.AGREE);</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (ApprovalProcessType.RESULT_REFUSE.equals(instanceChange.getResult())) {</span><br><span class="line">                    approvalCallbackEvent.setApprovalEventType(ApprovalEventType.REJECT);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    log.warn(<span class="string">"未知的审批实例结果. instanceChange: "</span> + instanceChange);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (ApprovalProcessType.TYPE_TERMINATE.equals(instanceChange.getType())) {</span><br><span class="line">                log.info(<span class="string">"发起人撤销审批单. instanceChange: "</span> + instanceChange);</span><br><span class="line">                approvalCallbackEvent.setApprovalEventType(ApprovalEventType.REJECT);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                log.warn(<span class="string">"未知的审批实例状态变更类型. instanceChange: "</span> + instanceChange);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 设置事件基础值</span></span><br><span class="line">        approvalBaseChange.setEventId(eventChange.getEventId());</span><br><span class="line">        approvalBaseChange.setEventType(eventChange.getEventType());</span><br><span class="line">        approvalBaseChange.setEventBornTime(eventChange.getEventBornTime());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询审批实例对应的租户id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="built_in">this</span>.getDdApprovalBusinessRelService().getTenantIdByInstance(approvalBaseChange.getProcessInstanceId());</span><br><span class="line">        <span class="keyword">if</span> (tenantId == <span class="literal">null</span>) {</span><br><span class="line">            log.warn(<span class="string">"无法确定钉钉审批实例对应的租户信息，请确认审批实例数据来源是否合规."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO 业务系统 手动切换数据源</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 上下文配置租户信息</span></span><br><span class="line">            DingTalkConfig.setTenantIdContext(tenantId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据流程实例id 查询审批业务关联单据</span></span><br><span class="line">            <span class="type">DdApprovalBusinessRel</span> <span class="variable">ddApprovalBusinessRel</span> <span class="operator">=</span> <span class="built_in">this</span>.getDdApprovalBusinessRelService().getDdApprovalBusinessRelByInstance(approvalBaseChange.getProcessInstanceId());</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">tenantName</span> <span class="operator">=</span> DingTalkConfig.getTenantPropertiesValue(tenantId, DingTalkTenantProperties::getTenantName);</span><br><span class="line">            <span class="keyword">if</span> (ddApprovalBusinessRel == <span class="literal">null</span>) {</span><br><span class="line">                log.error(String.format(<span class="string">"租户[%s]审批实例不存在, instanceId: %s"</span>, tenantName, approvalBaseChange.getProcessInstanceId()));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据code获取枚举</span></span><br><span class="line">            <span class="type">BusinessApprovalTypeEnum</span> <span class="variable">approvalTypeEnum</span> <span class="operator">=</span> BusinessApprovalTypeEnum.getApprovalFormEnum(ddApprovalBusinessRel.getTypeCode());</span><br><span class="line">            <span class="keyword">if</span> (approvalTypeEnum == <span class="literal">null</span>) {</span><br><span class="line">                log.error(String.format(<span class="string">"租户[%s]找不到对应的业务审批类型，请确认是否进行过变更。业务审批关联数据: %s"</span>, tenantName, ddApprovalBusinessRel));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取审批人</span></span><br><span class="line">            <span class="type">DdUserRel</span> <span class="variable">ddUserRel</span> <span class="operator">=</span> getDdUserRelService().resolveDdUserRel(tenantId, approvalBaseChange.getStaffId());</span><br><span class="line">            <span class="keyword">if</span> (ddUserRel == <span class="literal">null</span>) {</span><br><span class="line">                log.warn(String.format(<span class="string">"租户[%s]无法找到可以关联的用户，钉钉用户id为[%s]"</span>, tenantName, approvalBaseChange.getStaffId()));</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                approvalCallbackEvent.setUserId(ddUserRel.getScmUserId());</span><br><span class="line">                approvalBaseChange.setStaffName(ddUserRel.getDdUserName());</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据审批任务生成审批流程日志</span></span><br><span class="line">            <span class="keyword">if</span> (approvalBaseChange <span class="keyword">instanceof</span> ApprovalTaskChange) {</span><br><span class="line">                <span class="built_in">this</span>.getDdApprovalProcessLogService().generateLog((ApprovalTaskChange) approvalBaseChange, tenantId, ddApprovalBusinessRel.getId());</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据枚举+钉钉事件类型 调用监听的方法</span></span><br><span class="line">            List&lt;DingTalkCallbackListener&gt; listeners = DingTalkConfig.getCallbackListener(approvalTypeEnum, approvalCallbackEvent.getApprovalEventType());</span><br><span class="line">            <span class="keyword">if</span> (listeners == <span class="literal">null</span>) {</span><br><span class="line">                log.warn(String.format(<span class="string">"租户[%s]未配置审批类型为[%s],事件类型为[%s]的回调监听器, 跳过钉钉回调事件"</span>, tenantName, approvalTypeEnum.getName(), approvalCallbackEvent.getApprovalEventType().name()));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 填充回调事件对象数据</span></span><br><span class="line">            approvalCallbackEvent.setEventId(eventChange.getEventId());</span><br><span class="line">            approvalCallbackEvent.setEventType(eventChange.getEventType());</span><br><span class="line">            approvalCallbackEvent.setEventBornTime(eventChange.getEventBornTime());</span><br><span class="line">            approvalCallbackEvent.setTenantId(tenantId);</span><br><span class="line">            approvalCallbackEvent.setBusinessId(ddApprovalBusinessRel.getBusinessId());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 业务回调处理</span></span><br><span class="line">            <span class="keyword">for</span> (DingTalkCallbackListener listener : listeners) {</span><br><span class="line">                listener.callback(approvalCallbackEvent);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            log.info(String.format(<span class="string">"租户[%s]处理钉钉回调事件完成, 回调事件对象: %s"</span>, tenantName, approvalCallbackEvent));</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            DingTalkConfig.removeTenantIdContext();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DdApprovalProcessLogService <span class="title function_">getDdApprovalProcessLogService</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.ddApprovalProcessLogService == <span class="literal">null</span>) {</span><br><span class="line">            <span class="built_in">this</span>.ddApprovalProcessLogService = SpringUtil.getBean(DdApprovalProcessLogService.class);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.ddApprovalProcessLogService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DdApprovalBusinessRelService <span class="title function_">getDdApprovalBusinessRelService</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.ddApprovalBusinessRelService == <span class="literal">null</span>) {</span><br><span class="line">            <span class="built_in">this</span>.ddApprovalBusinessRelService = SpringUtil.getBean(DdApprovalBusinessRelService.class);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.ddApprovalBusinessRelService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DdUserRelService <span class="title function_">getDdUserRelService</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.ddUserRelService == <span class="literal">null</span>) {</span><br><span class="line">            <span class="built_in">this</span>.ddUserRelService = SpringUtil.getBean(DdUserRelService.class);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.ddUserRelService;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>AbstractDingTalkStreamEventListener</code> 通过模板模式，将审批事件的实现方法进行抽象。这样做的目的是为了后期可能会接入钉钉的其他事件类型，例如通讯录变更事件。。。</p>
<p>在 <code>ApprovalCallbackEventListener</code> 重写的 <code>handleApprovalEvent</code> 方法的最后，可以看到通过遍历 <code>listeners</code> 变量，回调了业务方法。</p>
<h4 id="回调的流程记录"><a class="header-anchor" href="#回调的流程记录"></a>回调的流程记录</h4>
<p>钉钉OA审批流程记录的数据与审批任务是保持一致的，因此在审批事件回调中，对审批事件类型为审批任务的事件进行拦截处理即可。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DdApprovalProcessLogService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DdApprovalProcessLogDao ddApprovalProcessLogDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DdApprovalProcessLogAttachmentDao ddApprovalProcessLogAttachmentDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateLog</span><span class="params">(ApprovalTaskChange taskChange, Long tenantId, Long businessRelId)</span> {</span><br><span class="line">        <span class="comment">// 钉钉事件id已存在业务系统数据表中，忽略重复请求</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> ddApprovalProcessLogDao.lambdaQuery()</span><br><span class="line">                .eq(DdApprovalProcessLog::getTenantId, tenantId)</span><br><span class="line">                .eq(DdApprovalProcessLog::getEventId, taskChange.getEventId())</span><br><span class="line">                .count();</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">// 已生成日志 ignore</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存审批流程记录</span></span><br><span class="line">        <span class="type">DdApprovalProcessLog</span> <span class="variable">approvalProcessLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DdApprovalProcessLog</span>();</span><br><span class="line">        approvalProcessLog.setTenantId(tenantId);</span><br><span class="line">        approvalProcessLog.setBusinessRelId(businessRelId);</span><br><span class="line">        approvalProcessLog.setEventId(taskChange.getEventId());</span><br><span class="line">        approvalProcessLog.setTaskId(taskChange.getTaskId());</span><br><span class="line">        approvalProcessLog.setStaffId(taskChange.getStaffId());</span><br><span class="line">        approvalProcessLog.setStaffName(taskChange.getStaffName());</span><br><span class="line">        approvalProcessLog.setProcessContent(taskChange.getContent() != <span class="literal">null</span> ? taskChange.getContent() : taskChange.getRemark());</span><br><span class="line">        approvalProcessLog.setCreateTime(taskChange.getEventBornTime());</span><br><span class="line">        <span class="type">ApprovalProcessType</span> <span class="variable">processType</span> <span class="operator">=</span> ApprovalProcessType.confirmProcessType(taskChange.getType(), taskChange.getResult());</span><br><span class="line">        approvalProcessLog.setProcessType(processType.getCode());</span><br><span class="line">        ddApprovalProcessLogDao.save(approvalProcessLog);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存当前审批操作中附带的附件</span></span><br><span class="line">        <span class="built_in">this</span>.saveLogAttachment(taskChange, tenantId, approvalProcessLog.getId());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveLogAttachment</span><span class="params">(ApprovalTaskChange taskChange, Long tenantId, Long logId)</span> {</span><br><span class="line">        <span class="comment">// 查询审批实例详情</span></span><br><span class="line">        GetProcessInstanceResponseBody.<span class="type">GetProcessInstanceResponseBodyResult</span> <span class="variable">instanceResponse</span> <span class="operator">=</span> DingTalkWorkflowClient.getProcessInstanceById(taskChange.getProcessInstanceId());</span><br><span class="line">        List&lt;GetProcessInstanceResponseBody.GetProcessInstanceResponseBodyResultOperationRecords&gt; operationRecords = instanceResponse.getOperationRecords();</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">simpleDateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">"yyyy-MM-dd'T'HH:mm'Z'"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">eventBornTime</span> <span class="operator">=</span> simpleDateFormat.format(taskChange.getEventBornTime());</span><br><span class="line">        <span class="comment">// 遍历审批实例详情中的操作记录，找到与当前审批操作匹配的记录</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> operationRecords.size() - <span class="number">1</span>; len &gt;= <span class="number">0</span>; len--) {</span><br><span class="line">            GetProcessInstanceResponseBody.<span class="type">GetProcessInstanceResponseBodyResultOperationRecords</span> <span class="variable">records</span> <span class="operator">=</span> operationRecords.get(len);</span><br><span class="line">            <span class="keyword">if</span> (!taskChange.getStaffId().equals(records.getUserId())) {</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (!eventBornTime.equals(records.getDate())) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="type">Date</span> <span class="variable">parse</span> <span class="operator">=</span> simpleDateFormat.parse(records.getDate());</span><br><span class="line">                    <span class="type">long</span> <span class="variable">after</span> <span class="operator">=</span> parse.getTime() + (<span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">                    <span class="keyword">if</span> (after &lt; taskChange.getEventBornTime().getTime()) {</span><br><span class="line">                        <span class="comment">// 操作记录的时间点 小于 事件发生的事件点</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (ParseException e) {</span><br><span class="line">                    <span class="comment">// ignore</span></span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 匹配到审批操作记录，判断当前审批操作是否携带附件</span></span><br><span class="line">            <span class="keyword">if</span> (CollectionUtils.isNotEmpty(records.getAttachments())) {</span><br><span class="line">                List&lt;String&gt; fileIdList = records.getAttachments()</span><br><span class="line">                        .stream()</span><br><span class="line">                        .map(GetProcessInstanceResponseBody.GetProcessInstanceResponseBodyResultOperationRecordsAttachments::getFileId)</span><br><span class="line">                        .collect(Collectors.toList());</span><br><span class="line">                <span class="comment">// 为附件临时授权可访问</span></span><br><span class="line">                DingTalkWorkflowClient.authorizeApprovalDentry(fileIdList);</span><br><span class="line">                <span class="comment">// 遍历获取附件信息并上传到业务系统文件服务器，保存审批流程记录的附件信息</span></span><br><span class="line">                <span class="keyword">for</span> (GetProcessInstanceResponseBody.GetProcessInstanceResponseBodyResultOperationRecordsAttachments attachment : records.getAttachments()) {</span><br><span class="line">                    <span class="type">String</span> <span class="variable">wyysFileUrl</span> <span class="operator">=</span> <span class="built_in">this</span>.uploadFileToBusinessSystem(attachment.getFileId(), attachment.getFileName());</span><br><span class="line">                    <span class="keyword">if</span> (wyysFileUrl == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="type">DdApprovalProcessLogAttachment</span> <span class="variable">logAttachment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DdApprovalProcessLogAttachment</span>();</span><br><span class="line">                    logAttachment.setTenantId(tenantId);</span><br><span class="line">                    logAttachment.setLogId(logId);</span><br><span class="line">                    logAttachment.setFileName(attachment.getFileName());</span><br><span class="line">                    logAttachment.setFileType(attachment.getFileType());</span><br><span class="line">                    logAttachment.setFileUrl(wyysFileUrl);</span><br><span class="line">                    ddApprovalProcessLogAttachmentDao.save(logAttachment);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">uploadFileToBusinessSystem</span><span class="params">(String fileId, String fileName)</span> {</span><br><span class="line">        GetFileDownloadInfoResponseBody.<span class="type">GetFileDownloadInfoResponseBodyHeaderSignatureInfo</span> <span class="variable">headerSignatureInfo</span> <span class="operator">=</span> DingTalkStorageClient.getFileDownloadInfo(fileId);</span><br><span class="line">        <span class="keyword">if</span> (headerSignatureInfo == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// http下载文件</span></span><br><span class="line">        <span class="type">HttpRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> HttpRequest.post(headerSignatureInfo.getResourceUrls().get(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : headerSignatureInfo.getHeaders().entrySet()) {</span><br><span class="line">            httpRequest.header(entry.getKey(), entry.getValue());</span><br><span class="line">        }</span><br><span class="line">        <span class="type">HttpResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> httpRequest.execute();</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> httpResponse.bodyStream();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存到业务系统文件服务器，并返回全量路径地址</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="总结"><a class="header-anchor" href="#总结"></a>总结</h2>
<ol>
<li>钉钉开放平台的接口太“开放”了，大多数请求基本上都很难通过一个接口搞定。但人家这样设计自然有它的道理，个人猜想它的设计思路：
<ol>
<li>从功能模块方面：将每个接口所做的功能尽可能细化，做到服务端实现逻辑的解耦。</li>
<li>从接口响应方面：因为接口功能涉及影响面较小，需要处理的数据交互也小很多，响应时间也会缩短。</li>
</ol>
</li>
<li>在搭建整个钉钉OA审批框架时，在包定义、类名定义上不够严谨，感觉子模块的区分还是没有做好，Config与Model有点混乱，还是需要多看看大佬的框架源码。</li>
<li>Client的异常处理，还是没有想出好的方法做通用处理，每个方法都要try-catch一模一样的内容。</li>
<li>没有考虑高并发情况，核心模块需要做锁处理；另外，没有考虑分布式微服务场景。</li>
<li>审批回调的重试机制不能单方面依赖钉钉，需要自己做一层异常重试处理机制；此外，钉钉重试间隔时间很短暂，因此回调处理时间不能太长。可以结合自己做异常重试机制，将回调事件做异步操作。</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.itwray.com">Wray</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.itwray.com/2023/09/01/work-report-ddoa2/">https://blog.itwray.com/2023/09/01/work-report-ddoa2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.itwray.com" target="_blank">Wray Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%B7%A5%E4%BD%9C%E5%B0%8F%E7%BB%93/">工作小结</a><a class="post-meta__tags" href="/tags/OA%E5%AE%A1%E6%89%B9/">OA审批</a></div><div class="post_share"><div class="social-share" data-image="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/drone-8499903_1920.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/09/05/hexo-readme/" title="Hexo博客Git项目添加README文件"><img class="cover" src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/european-shorthair-8330819_1920.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Hexo博客Git项目添加README文件</div></div></a></div><div class="next-post pull-right"><a href="/2023/08/29/hexo-github-site/" title="GitHub Pages配置到个人站点"><img class="cover" src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/dog-8448345_1920.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">GitHub Pages配置到个人站点</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/08/25/work-report-ddoa/" title="工作小结-钉钉OA审批"><img class="cover" src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/desert-8430551_1920.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-25</div><div class="title">工作小结-钉钉OA审批</div></div></a></div><div><a href="/2024/01/03/work-report-oa3/" title="工作小结-OA审批(3)"><img class="cover" src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/sunset-8327637_1920.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-03</div><div class="title">工作小结-OA审批(3)</div></div></a></div><div><a href="/2024/01/13/work-report-dingtalk-robot/" title="工作小结-接入钉钉机器人"><img class="cover" src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/winter-8433264_1920.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-13</div><div class="title">工作小结-接入钉钉机器人</div></div></a></div><div><a href="/2024/01/05/work-report-business-sn/" title="工作小结-业务编号生成器"><img class="cover" src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/sunset-8459057_1920.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-05</div><div class="title">工作小结-业务编号生成器</div></div></a></div><div><a href="/2024/01/10/work-report-mybatisplus-fill/" title="工作小结-MyBatis-Plus填充策略"><img class="cover" src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/wave-8253292_1920.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-10</div><div class="title">工作小结-MyBatis-Plus填充策略</div></div></a></div><div><a href="/2024/01/08/work-report-shedlock/" title="工作小结-ShedLock的使用"><img class="cover" src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/sunset-8485910_1920.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-08</div><div class="title">工作小结-ShedLock的使用</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/touxiang.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">Wray</div><div class="author-info__description">记录生活的点点滴滴<br>Keep track of my life</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">框架目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="toc-number">3.</span> <span class="toc-text">设计思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%A1%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.1.</span> <span class="toc-text">数据表设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E7%B1%BB%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.2.</span> <span class="toc-text">关键类设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E8%B5%B7%E5%AE%A1%E6%89%B9%E6%B5%81%E7%A8%8B"><span class="toc-number">3.3.</span> <span class="toc-text">发起审批流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E5%8F%82%E5%AF%B9%E8%B1%A1%E5%88%86%E6%9E%90"><span class="toc-number">3.3.1.</span> <span class="toc-text">入参对象分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%B9%B6%E8%8E%B7%E5%8F%96%E5%AE%A1%E6%89%B9%E6%A8%A1%E6%9D%BF"><span class="toc-number">3.3.2.</span> <span class="toc-text">创建并获取审批模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%A1%E6%89%B9%E5%8F%91%E8%B5%B7%E4%BA%BA%E5%AF%B9%E5%BA%94%E7%9A%84%E9%92%89%E9%92%89%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">3.3.3.</span> <span class="toc-text">获取审批发起人对应的钉钉用户信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E8%B5%B7%E5%AE%A1%E6%89%B9%E5%AE%9E%E4%BE%8B"><span class="toc-number">3.3.4.</span> <span class="toc-text">发起审批实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A1%E6%89%B9%E4%BA%8B%E4%BB%B6%E5%9B%9E%E8%B0%83"><span class="toc-number">3.4.</span> <span class="toc-text">审批事件回调</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%9B%9E%E8%B0%83%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">3.4.1.</span> <span class="toc-text">业务回调使用方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">3.4.2.</span> <span class="toc-text">回调方法实现原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83%E7%BB%9F%E4%B8%80%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95"><span class="toc-number">3.4.3.</span> <span class="toc-text">回调统一处理方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83%E7%9A%84%E6%B5%81%E7%A8%8B%E8%AE%B0%E5%BD%95"><span class="toc-number">3.4.4.</span> <span class="toc-text">回调的流程记录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/05/14/life-20240514/" title="生活日记-20240514"><img src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240514153433.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="生活日记-20240514"></a><div class="content"><a class="title" href="/2024/05/14/life-20240514/" title="生活日记-20240514">生活日记-20240514</a><time datetime="2024-05-14T05:44:51.000Z" title="发表于 2024-05-14 13:44:51">2024-05-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/01/life-20240401/" title="生活日记-20240401"><img src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240401155046.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="生活日记-20240401"></a><div class="content"><a class="title" href="/2024/04/01/life-20240401/" title="生活日记-20240401">生活日记-20240401</a><time datetime="2024-04-01T07:48:34.000Z" title="发表于 2024-04-01 15:48:34">2024-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/04/springdoc-hello/" title="再见SpringFox，你好SpringDoc"><img src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240304173959.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="再见SpringFox，你好SpringDoc"></a><div class="content"><a class="title" href="/2024/03/04/springdoc-hello/" title="再见SpringFox，你好SpringDoc">再见SpringFox，你好SpringDoc</a><time datetime="2024-03-04T07:35:59.000Z" title="发表于 2024-03-04 15:35:59">2024-03-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/02/29/life-20240229/" title="生活日记-20240229"><img src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240229142945.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="生活日记-20240229"></a><div class="content"><a class="title" href="/2024/02/29/life-20240229/" title="生活日记-20240229">生活日记-20240229</a><time datetime="2024-02-29T09:26:08.000Z" title="发表于 2024-02-29 17:26:08">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/23/git-study-10/" title="Git学习-Git内部原理"><img src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/field-8419729_1920.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Git学习-Git内部原理"></a><div class="content"><a class="title" href="/2024/01/23/git-study-10/" title="Git学习-Git内部原理">Git学习-Git内部原理</a><time datetime="2024-01-23T09:02:49.000Z" title="发表于 2024-01-23 17:02:49">2024-01-23</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2023 - 2024 By Wray</div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/"><span>鄂ICP备2024050235号-1</span></a> <a href="https://beian.mps.gov.cn/#/query/webSearch?code=42018502007471" rel="noreferrer" target="_blank"><img class="icp-icon" src="https://itwray-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/beian.png"><span>鄂公网安备42018502007471</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>